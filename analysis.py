import gzip
import math
import numpy as np
import collections
import scipy.stats

EP_LANGS = list("bg cs da de el en es et fi fr hu it lt lv nl pl pt ro sk sl sv".split())
BIBLES = list("afr-1953 aln-aln arb-arb arz-arz ayr-1997 ayr-2011 bba-bba ben-common ben-mussolmani bqc-bqc bul-bul bul-veren cac-ixtatan cak-central2003 ceb-bugna2009 ceb-bugna ceb-pinadayag ces-ekumenicky ces-kralicka cmn-sf_ncv-zefania cnh-cnh cym-morgan1804 dan-1931 deu-elberfelder1871 deu-elberfelder1905 deu-freebible deu-gruenewalder deu-luther1545letztehand deu-luther1912 deu-neue deu-pattloch deu-schlachter deu-textbibel deu-zuercher ell-modern2009 eng-darby eng-kingjames eng-literal eng-newsimplified epo-epo fin-1766 fin-1933 fin-1992 fra-bonnet fra-crampon fra-darby fra-davidmartin fra-jerusalem2004 fra-kingjames fra-louissegond fra-ostervald1867 fra-paroledevie fra-perret fra-pirotclamer guj-guj gur-frafra hat-1985 hat-1999 hrv-hrv hun-2005 hun-karoli ind-suciinjil ind-terjemahanbaru ita-2009 ita-diodati ita-nuovadiodati1991 ita-riveduta kek-1988 kek-2005 kjb-kjb lat-novavulgata lit-lit mah-mah mam-northern mri-mri mya-mya nld-nld nor-nor nor-student plt-romancatholic poh-eastern por-almeidaatualizada por-almeidarevista por-paratodos qub-qub quh-1993 quy-quy quz-quz ron-cornilescu rus-synodal som-som tbz-tbz tcw-tcw tgl-1905 tlh-klingon tpi-tpi tpm-tpm ukr-1962 ukr-2009 vie-1926compounds vie-1926nocompounds vie-2002 wal-wal wbm-wbm xho-xho zom-zom".split())
BIBLE_LANGS = sorted(list(set([l[:3] for l in BIBLES])))

MCC = {"bg": 96, "cs": 195, "da": 15, "de": 38, "el": 50, "en": 6, "es": 71, "et": 110, "fi": 198, "fr": 30, "hu": 94, "it": 52, "lt": 152, "lv": 81, "nl": 26, "pl": 112, "pt": 77, "ro": 60, "sk": 40, "sl": 100, "sv": 35}

ADL = {"bg": 2.1448, "cs": 2.1842, "da": 2.2354, "de": 3.3816, "el": 2.2201, "en": 2.3811, "es": 2.1303, "et": 2.3930, "fi": 2.1296, "fr": 2.1860, "hu": 2.6538, "it": 2.1621, "lt": 1.9875, "lv": 2.3488, "nl": 2.8690, "pl": 2.1897, "pt": 2.1335, "ro": 2.1287, "sk": 2.1626, "sl": 2.2267, "sv": 2.3498}  # europarl_test.predicted
HPE_MEAN = {"bg": 0.4602, "cs": 0.4281, "da": 0.4848, "de": 0.4231, "el": 0.5027, "en": 0.7183, "es": 0.5000, "et": 0.4105, "fi": 0.3301, "fr": 0.5713, "hu": 0.3896, "it": 0.5523, "lt": 0.5151, "lv": 0.4356, "nl": 0.5274, "pl": 0.4573, "pt": 0.5566, "ro": 0.5339, "sk": 0.4170, "sl": 0.4222, "sv": 0.4789}  # europarl_test.predicted.mean
HPE_SKEW = {"bg": 1.1470, "cs": 1.2267, "da": 1.1836, "de": 1.2564, "el": 0.9930, "en": 0.5745, "es": 0.8624, "et": 1.2479, "fi": 1.4903, "fr": 0.8896, "hu": 1.3193, "it": 0.7962, "lt": 1.0577, "lv": 1.0965, "nl": 1.0467, "pl": 1.1667, "pt": 0.8829, "ro": 0.9358, "sk": 1.2541, "sl": 1.1620, "sv": 1.1365}  # europarl_test.predicted.skew

RNNLM_BPE_BEST = {"bg": 0.9776830365596102, "cs": 1.023774419652738, "da": 0.9614692641326111, "de": 1.0462878819482202, "el": 1.0213555003716335, "en": 0.9771985689193936, "es": 1.0139125082322042, "et": 1.0103419501319477, "fi": 0.9796466192941315, "fr": 0.9879091049592464, "hu": 1.0435976238653106, "it": 1.0023747931815494, "lt": 0.9828063001786972, "lv": 0.970564905308511, "nl": 1.0168492015871058, "pl": 1.0255810216359165, "pt": 1.0140235536186029, "ro": 1.0143962642454472, "sk": 0.9868867136440177, "sl": 0.9829983879833005, "sv": 0.9603423805498029}
RNNLM_BPE_04 = {"bg": 0.9805214978730262, "cs": 1.0205570321110016, "da": 0.9590695606629054, "de": 1.0461151137157485, "el": 1.0197310530837296, "en": 0.9897237375861424, "es": 1.0065862978871367, "et": 1.0083758294975997, "fi": 0.978866985381992, "fr": 0.9948755141573606, "hu": 1.0387147916282795, "it": 1.0032109212333054, "lt": 0.981979300015945, "lv": 0.9654191872884096, "nl": 1.0176801533884972, "pl": 1.0252212797326505, "pt": 1.0139931401864328, "ro": 1.0215232548112343, "sk": 0.9837294757782766, "sl": 0.9844698544321169, "sv": 0.9596360195482083}
RNNLM_CHARS = {"bg": 0.992440895210237, "cs": 0.9973538281475332, "da": 0.9786835171141176, "de": 1.1138574929237592, "el": 0.9860314008141875, "en": 0.9533350332641167, "es": 1.0227136375057682, "et": 1.0287872780865062, "fi": 0.9951061703398807, "fr": 1.0454498739782991, "hu": 1.0444656606483425, "it": 0.9875958578332857, "lt": 0.9706411558598212, "lv": 0.9295915135189362, "nl": 1.0121045354762734, "pl": 1.0617089370380879, "pt": 1.016045999069553, "ro": 0.9990649794367946, "sk": 0.956497655278461, "sl": 0.9497735792695036, "sv": 0.9587509991865331, }

RNNLM_BPE_04.update({"afr-1953": 0.9369714169953165, "aln-aln": 0.9984412361828813, "arb-arb": 1.0068925189351778, "arz-arz": 1.0624883420783586, "ayr-1997": 1.2186681358294553, "ayr-2011": 1.0822267285351073, "bba-bba": 0.8489613015299036, "ben-common": 0.9587613866299773, "ben-mussolmani": 0.956800498933373, "bqc-bqc": 0.8605909988598617, "bul-bul": 1.0272833455535653, "bul-veren": 0.9516954973727545, "cac-ixtatan": 0.9550361343061163, "cak-central2003": 1.042798124683693, "ceb-bugna2009": 1.0028176545649192, "ceb-bugna": 1.0342410340346562, "ceb-pinadayag": 1.036505589615889, "ces-ekumenicky": 1.0820548707676518, "ces-kralicka": 1.0646191565642003, "cmn-sf_ncv-zefania": 1.1067620144936012, "cnh-cnh": 0.9881596889145825, "cym-morgan1804": 0.968238601302298, "dan-1931": 0.9804064255473182, "deu-elberfelder1871": 0.9947471693948595, "deu-elberfelder1905": 0.9822934747779858, "deu-freebible": 0.9809008262830167, "deu-gruenewalder": 1.0949788327740888, "deu-luther1545letztehand": 1.0811836162308484, "deu-luther1912": 0.9524239899418494, "deu-neue": 1.0323561687425329, "deu-pattloch": 1.0711759618056809, "deu-schlachter": 1.0105258558494956, "deu-textbibel": 1.0923813818915826, "deu-zuercher": 1.0285200803296959, "ell-modern2009": 0.9838233997080846, "eng-darby": 0.9359082547463613, "eng-kingjames": 0.9035373976608329, "eng-literal": 0.9118040529521513, "eng-newsimplified": 0.9323314188774935, "epo-epo": 0.9038778412567232, "fin-1766": 1.0088280025359784, "fin-1933": 1.064829012051266, "fin-1992": 1.0910239246766258, "fra-bonnet": 0.9722729072610353, "fra-crampon": 0.9974523326520395, "fra-darby": 0.9395735014587434, "fra-davidmartin": 0.9811443027650152, "fra-jerusalem2004": 1.0079156965066467, "fra-kingjames": 0.9402325026697749, "fra-louissegond": 0.924291822389733, "fra-ostervald1867": 0.972541024188374, "fra-paroledevie": 0.8885076816949418, "fra-perret": 1.0327128387997349, "fra-pirotclamer": 1.0170236678990934, "guj-guj": 1.1959216312193515, "gur-frafra": 0.9793484001312686, "hat-1985": 0.9231173898068785, "hat-1999": 0.9333871846481263, "hrv-hrv": 1.0987465151214242, "hun-2005": 1.092271748002482, "hun-karoli": 1.1329052131760053, "ind-suciinjil": 0.9419499410898077, "ind-terjemahanbaru": 0.9466259952422177, "ita-2009": 0.9948954816061665, "ita-diodati": 1.0094598719827563, "ita-nuovadiodati1991": 0.9959725029861614, "ita-riveduta": 1.0362765164739145, "kek-1988": 0.881396641345153, "kek-2005": 0.8917082385533217, "kjb-kjb": 1.0120653237311719, "lat-novavulgata": 1.0235723913327466, "lit-lit": 0.9676099349994501, "mah-mah": 0.868953107389486, "mam-northern": 0.9222806896045849, "mri-mri": 0.9247804440654968, "mya-mya": 1.105192934956928, "nld-nld": 0.981872824504031, "nor-nor": 0.9323789593558802, "nor-student": 1.007883316383292, "plt-romancatholic": 1.0047450748500297, "poh-eastern": 1.00627518567627, "por-almeidaatualizada": 0.9860171340911811, "por-almeidarevista": 0.9703018074181619, "por-paratodos": 0.9867318039104979, "qub-qub": 1.0653282218259015, "quh-1993": 1.0971309295833047, "quy-quy": 1.0935389345494908, "quz-quz": 1.0494495159372774, "ron-cornilescu": 0.9681052018016923, "rus-synodal": 1.0359990959794352, "som-som": 1.0377642215218268, "tbz-tbz": 0.8642135958984271, "tcw-tcw": 1.287401302306497, "tgl-1905": 0.9596313737758607, "tlh-klingon": 0.889267730599337, "tpi-tpi": 0.8850998108191068, "tpm-tpm": 0.879224753802524, "ukr-1962": 1.079328251688754, "ukr-2009": 1.0893778702972317, "vie-1926compounds": 0.9886599597660448, "vie-1926nocompounds": 0.98815354399238, "vie-2002": 1.0077588873748347, "wal-wal": 0.9768236591647071, "wbm-wbm": 0.9703408039045761, "xho-xho": 1.1379232759385498, "zom-zom": 0.9922952128150517})
RNNLM_CHARS.update({"afr-1953": 1.0033210756875806, "aln-aln": 0.978874121535872, "arb-arb": 0.8551993179307802, "arz-arz": 0.9194445651427833, "ayr-1997": 1.0857332765805072, "ayr-2011": 1.0068479384466804, "bba-bba": 0.8587793946715038, "ben-common": 0.983159764817062, "ben-mussolmani": 0.9963722472440246, "bqc-bqc": 0.852028337120521, "bul-bul": 1.0119814972601797, "bul-veren": 0.9360999549057114, "cac-ixtatan": 1.0364042411149574, "cak-central2003": 1.0949451311865357, "ceb-bugna2009": 1.0726467778953983, "ceb-bugna": 1.081130979270843, "ceb-pinadayag": 1.0709377822557804, "ces-ekumenicky": 0.9947744584759874, "ces-kralicka": 1.046875401161303, "cmn-sf_ncv-zefania": 0.8384818895007089, "cnh-cnh": 1.040607691758975, "cym-morgan1804": 0.9903219121648621, "dan-1931": 1.0037672665570359, "deu-elberfelder1871": 1.0895227287983886, "deu-elberfelder1905": 1.0456421906376405, "deu-freebible": 1.0300856989797669, "deu-gruenewalder": 1.1198651824447199, "deu-luther1545letztehand": 1.103150611134703, "deu-luther1912": 0.9935860667633354, "deu-neue": 1.0403290111782313, "deu-pattloch": 1.106228042893884, "deu-schlachter": 1.0530113391606886, "deu-textbibel": 1.1031451907520213, "deu-zuercher": 1.0311606006634881, "ell-modern2009": 0.9990055919717958, "eng-darby": 1.0077001192798378, "eng-kingjames": 0.9239082075169177, "eng-literal": 0.9859821595805798, "eng-newsimplified": 0.9538539872159567, "epo-epo": 0.9216254935854604, "fin-1766": 0.9793702370924567, "fin-1933": 1.0174553648035058, "fin-1992": 0.9817543509915446, "fra-bonnet": 0.9815257501063548, "fra-crampon": 0.9915918009839948, "fra-darby": 0.9486512089416633, "fra-davidmartin": 0.9801571453459758, "fra-jerusalem2004": 1.000247383573812, "fra-kingjames": 0.9851933836850434, "fra-louissegond": 0.9285594990453857, "fra-ostervald1867": 1.0035910231492224, "fra-paroledevie": 0.9050445769093435, "fra-perret": 1.0615101721627114, "fra-pirotclamer": 1.0060938734872482, "guj-guj": 1.1740929764286503, "gur-frafra": 1.0177795468880553, "hat-1985": 0.957578694326246, "hat-1999": 0.9703378301690398, "hrv-hrv": 0.9957551029147339, "hun-2005": 1.0020493033981939, "hun-karoli": 1.0222314233347343, "ind-suciinjil": 0.9960827883743165, "ind-terjemahanbaru": 0.9811215942637709, "ita-2009": 1.0021482915773992, "ita-diodati": 1.0347266569808349, "ita-nuovadiodati1991": 1.0352963724563746, "ita-riveduta": 1.0714236643023727, "kek-1988": 0.9711254841923632, "kek-2005": 0.9336783250887769, "kjb-kjb": 1.064683513386702, "lat-novavulgata": 0.9513372858935284, "lit-lit": 0.8864235810332368, "mah-mah": 0.9654114753754169, "mam-northern": 0.9802833693159422, "mri-mri": 0.9801931231540562, "mya-mya": 0.9996390293025839, "nld-nld": 1.0084411948243153, "nor-nor": 0.9276851591859374, "nor-student": 1.0049300482216312, "plt-romancatholic": 0.9800058085375064, "poh-eastern": 1.1067334944572318, "por-almeidaatualizada": 0.9783887655946776, "por-almeidarevista": 1.0008672254401185, "por-paratodos": 1.0290896401544645, "qub-qub": 0.9606395529403273, "quh-1993": 0.9764873646511151, "quy-quy": 1.0036978086312816, "quz-quz": 0.9385325505458554, "ron-cornilescu": 0.9771924164407895, "rus-synodal": 0.9668929561338128, "som-som": 1.0507963651688665, "tbz-tbz": 0.8807855231224273, "tcw-tcw": 1.2106565494812132, "tgl-1905": 1.0504897008326248, "tlh-klingon": 0.9630869992930884, "tpi-tpi": 0.985048550302751, "tpm-tpm": 0.8915940571305883, "ukr-1962": 1.026547795259944, "ukr-2009": 1.0281244062611563, "vie-1926compounds": 1.0173523941990483, "vie-1926nocompounds": 0.9968139368364002, "vie-2002": 1.0363751759761461, "wal-wal": 0.9427651960640046, "wbm-wbm": 1.0472260766401338, "xho-xho": 0.9943073886663659, "zom-zom": 0.9877634513275865})

CHARTOKS = {'bg': 25148200, 'cs': 22394058, 'da': 24061969, 'de': 27504698, 'el': 27060306, 'en': 24053152, 'es': 26126319, 'et': 22639731, 'fi': 24384337, 'fr': 27933072, 'hu': 25326872, 'it': 26302434, 'lt': 22878667, 'lv': 22908956, 'nl': 26420383, 'pl': 24963232, 'pt': 25829079, 'ro': 25820709, 'sk': 22895759, 'sl': 22208304, 'sv': 23607149}
BPETOKS = {'bg': 4352803, 'cs': 3821641, 'da': 4204440, 'de': 4339425, 'el': 4526222, 'en': 4436938, 'es': 4630414, 'et': 3355407, 'fi': 3286480, 'fr': 5129877, 'hu': 3873079, 'it': 4448479, 'lt': 3529223, 'lv': 3634932, 'nl': 4482725, 'pl': 3848507, 'pt': 4561000, 'ro': 4461251, 'sk': 3828543, 'sl': 3836836, 'sv': 3957993}  # I did this later, dunno how the other numbers came to be... weirdly enough it looks like the others are train set numbers so now this is too, what the fuck
WORDTOKS = {'bg': 4186131, 'cs': 3638364, 'da': 4062527, 'de': 4155122, 'el': 4317523, 'en': 4286827, 'es': 4491329, 'et': 3176617, 'fi': 3076441, 'fr': 4999874, 'hu': 3681101, 'it': 4312190, 'lt': 3367772, 'lv': 3474456, 'nl': 4339254, 'pl': 3656729, 'pt': 4414745, 'ro': 4294708, 'sk': 3639806, 'sl': 3669004, 'sv': 3812492}
WORDTYPES = {'bg': 73790, 'cs': 100911, 'da': 75876, 'de': 88302, 'el': 76407, 'en': 34450, 'es': 54998, 'et': 144415, 'fi': 164532, 'fr': 44716, 'hu': 148875, 'it': 55340, 'lt': 121211, 'lv': 92918, 'nl': 63342, 'pl': 104888, 'pt': 54609, 'ro': 62907, 'sk': 101666, 'sl': 88805, 'sv': 80867}
UNIGRAM_ENTROPY = {'bg': 10.011135651683604, 'cs': 11.073187186495211, 'da': 9.73240374780404, 'de': 10.067905181628417, 'el': 10.265281476097705, 'en': 9.367671838274674, 'es': 9.525776244530771, 'et': 11.490564059644749, 'fi': 11.703568515137201, 'fr': 9.352498989714007, 'hu': 10.91179047674946, 'it': 10.049156665491292, 'lt': 11.160130099427873, 'lv': 10.879622021680458, 'nl': 9.58415655565033, 'pl': 11.222905544152475, 'pt': 9.811481937581387, 'ro': 10.235144117010302, 'sk': 11.053255472541814, 'sl': 10.736994735198433, 'sv': 10.086898767935763}

CHARTOKS.update({'afr-1953': 2386190, 'aln-aln': 2338108, 'arb-arb': 1351265, 'arz-arz': 2293034, 'ayr-1997': 2811249, 'ayr-2011': 2589512, 'bba-bba': 2146769, 'ben-common': 2328909, 'ben-mussolmani': 2328163, 'bqc-bqc': 1570306, 'bul-bul': 2132039, 'bul-veren': 2077997, 'cac-ixtatan': 3052609, 'cak-central2003': 3168361, 'ceb-bugna2009': 2909359, 'ceb-bugna': 2932635, 'ceb-pinadayag': 2933345, 'ces-ekumenicky': 1959294, 'ces-kralicka': 2055865, 'cmn-sf_ncv-zefania': 780183, 'cnh-cnh': 2581907, 'cym-morgan1804': 2269804, 'dan-1931': 2090632, 'deu-elberfelder1871': 2492895, 'deu-elberfelder1905': 2497050, 'deu-freebible': 2491757, 'deu-gruenewalder': 2341199, 'deu-luther1545letztehand': 2520759, 'deu-luther1912': 2357683, 'deu-neue': 2420576, 'deu-pattloch': 2404683, 'deu-schlachter': 2441854, 'deu-textbibel': 2481892, 'deu-zuercher': 2434528, 'ell-modern2009': 2432255, 'eng-darby': 2403507, 'eng-kingjames': 2411260, 'eng-literal': 2333837, 'eng-newsimplified': 2229750, 'epo-epo': 2253897, 'fin-1766': 2371471, 'fin-1933': 2355588, 'fin-1992': 2306722, 'fra-bonnet': 2410213, 'fra-crampon': 2400871, 'fra-darby': 2456834, 'fra-davidmartin': 2585562, 'fra-jerusalem2004': 2306326, 'fra-kingjames': 2445163, 'fra-louissegond': 2403582, 'fra-ostervald1867': 2559276, 'fra-paroledevie': 2580841, 'fra-perret': 2433022, 'fra-pirotclamer': 2384944, 'guj-guj': 2323055, 'gur-frafra': 2344351, 'hat-1985': 2472189, 'hat-1999': 2452244, 'hrv-hrv': 1916220, 'hun-2005': 2148650, 'hun-karoli': 2229911, 'ind-suciinjil': 2734809, 'ind-terjemahanbaru': 2722443, 'ita-2009': 2221292, 'ita-diodati': 2484150, 'ita-nuovadiodati1991': 2360797, 'ita-riveduta': 2387316, 'kek-1988': 3117351, 'kek-2005': 2679980, 'kjb-kjb': 2909643, 'lat-novavulgata': 2052345, 'lit-lit': 1877014, 'mah-mah': 2201675, 'mam-northern': 2679179, 'mri-mri': 2601548, 'mya-mya': 2458954, 'nld-nld': 2527006, 'nor-nor': 2153732, 'nor-student': 2172763, 'plt-romancatholic': 2540445, 'poh-eastern': 3305529, 'por-almeidaatualizada': 2239724, 'por-almeidarevista': 2243075, 'por-paratodos': 2300156, 'qub-qub': 2625731, 'quh-1993': 2689506, 'quy-quy': 2757591, 'quz-quz': 2553335, 'ron-cornilescu': 2313761, 'rus-synodal': 1965148, 'som-som': 2646808, 'tbz-tbz': 2233332, 'tcw-tcw': 2621008, 'tgl-1905': 2823049, 'tlh-klingon': 2483734, 'tpi-tpi': 3383554, 'tpm-tpm': 2325712, 'ukr-1962': 2015675, 'ukr-2009': 2015861, 'vie-1926compounds': 2271582, 'vie-1926nocompounds': 2262567, 'vie-2002': 2214816, 'wal-wal': 2538145, 'wbm-wbm': 2909185, 'xho-xho': 2215940, 'zom-zom': 2302172})
BPETOKS.update({'afr-1953': 552110, 'aln-aln': 538005, 'arb-arb': 314263, 'arz-arz': 373702, 'ayr-1997': 427829, 'ayr-2011': 416810, 'bba-bba': 538002, 'ben-common': 484225, 'ben-mussolmani': 484179, 'bqc-bqc': 408968, 'bul-bul': 492340, 'bul-veren': 477140, 'cac-ixtatan': 635648, 'cak-central2003': 639640, 'ceb-bugna2009': 591616, 'ceb-bugna': 595631, 'ceb-pinadayag': 595832, 'ces-ekumenicky': 447730, 'ces-kralicka': 463148, 'cmn-sf_ncv-zefania': 318698, 'cnh-cnh': 618464, 'cym-morgan1804': 529166, 'dan-1931': 490419, 'deu-elberfelder1871': 531298, 'deu-elberfelder1905': 531837, 'deu-freebible': 531194, 'deu-gruenewalder': 508568, 'deu-luther1545letztehand': 549058, 'deu-luther1912': 506615, 'deu-neue': 516224, 'deu-pattloch': 514825, 'deu-schlachter': 519801, 'deu-textbibel': 523854, 'deu-zuercher': 522083, 'ell-modern2009': 510648, 'eng-darby': 559821, 'eng-kingjames': 559617, 'eng-literal': 547117, 'eng-newsimplified': 518503, 'epo-epo': 496400, 'fin-1766': 442738, 'fin-1933': 444290, 'fin-1992': 432642, 'fra-bonnet': 531389, 'fra-crampon': 533851, 'fra-darby': 548517, 'fra-davidmartin': 575737, 'fra-jerusalem2004': 513380, 'fra-kingjames': 543932, 'fra-louissegond': 531957, 'fra-ostervald1867': 559299, 'fra-paroledevie': 572347, 'fra-perret': 538275, 'fra-pirotclamer': 528094, 'guj-guj': 514885, 'gur-frafra': 562820, 'hat-1985': 626603, 'hat-1999': 620945, 'hrv-hrv': 436410, 'hun-2005': 450955, 'hun-karoli': 476178, 'ind-suciinjil': 498413, 'ind-terjemahanbaru': 495568, 'ita-2009': 477085, 'ita-diodati': 552247, 'ita-nuovadiodati1991': 510819, 'ita-riveduta': 529986, 'kek-1988': 602741, 'kek-2005': 521651, 'kjb-kjb': 657794, 'lat-novavulgata': 415162, 'lit-lit': 388516, 'mah-mah': 535458, 'mam-northern': 574168, 'mri-mri': 651676, 'mya-mya': 368963, 'nld-nld': 558729, 'nor-nor': 503079, 'nor-student': 505989, 'plt-romancatholic': 486101, 'poh-eastern': 687542, 'por-almeidaatualizada': 508930, 'por-almeidarevista': 515755, 'por-paratodos': 506514, 'qub-qub': 399587, 'quh-1993': 408345, 'quy-quy': 397288, 'quz-quz': 382363, 'ron-cornilescu': 520784, 'rus-synodal': 440124, 'som-som': 500323, 'tbz-tbz': 473842, 'tcw-tcw': 472210, 'tgl-1905': 572525, 'tlh-klingon': 548030, 'tpi-tpi': 767925, 'tpm-tpm': 584514, 'ukr-1962': 464297, 'ukr-2009': 464540, 'vie-1926compounds': 549565, 'vie-1926nocompounds': 567668, 'vie-2002': 553434, 'wal-wal': 447559, 'wbm-wbm': 658963, 'xho-xho': 395502, 'zom-zom': 521096})
WORDTOKS.update({'afr-1953': 511828, 'aln-aln': 494796, 'arb-arb': 266613, 'arz-arz': 299684, 'ayr-1997': 357547, 'ayr-2011': 355902, 'bba-bba': 513731, 'ben-common': 444372, 'ben-mussolmani': 443582, 'bqc-bqc': 377539, 'bul-bul': 446995, 'bul-veren': 433732, 'cac-ixtatan': 603910, 'cak-central2003': 603628, 'ceb-bugna2009': 553249, 'ceb-bugna': 556620, 'ceb-pinadayag': 556800, 'ces-ekumenicky': 391023, 'ces-kralicka': 412053, 'cmn-sf_ncv-zefania': 122517, 'cnh-cnh': 592223, 'cym-morgan1804': 486588, 'dan-1931': 445787, 'deu-elberfelder1871': 482740, 'deu-elberfelder1905': 483219, 'deu-freebible': 482718, 'deu-gruenewalder': 458948, 'deu-luther1545letztehand': 509307, 'deu-luther1912': 462989, 'deu-neue': 465069, 'deu-pattloch': 462646, 'deu-schlachter': 472271, 'deu-textbibel': 471696, 'deu-zuercher': 471945, 'ell-modern2009': 462443, 'eng-darby': 517421, 'eng-kingjames': 517339, 'eng-literal': 506930, 'eng-newsimplified': 475026, 'epo-epo': 459708, 'fin-1766': 392220, 'fin-1933': 383118, 'fin-1992': 368785, 'fra-bonnet': 487199, 'fra-crampon': 488989, 'fra-darby': 505330, 'fra-davidmartin': 532060, 'fra-jerusalem2004': 466252, 'fra-kingjames': 500186, 'fra-louissegond': 486989, 'fra-ostervald1867': 515435, 'fra-paroledevie': 528879, 'fra-perret': 490906, 'fra-pirotclamer': 482645, 'guj-guj': 467037, 'gur-frafra': 538980, 'hat-1985': 602264, 'hat-1999': 597787, 'hrv-hrv': 388325, 'hun-2005': 387285, 'hun-karoli': 414912, 'ind-suciinjil': 444167, 'ind-terjemahanbaru': 441656, 'ita-2009': 434353, 'ita-diodati': 511411, 'ita-nuovadiodati1991': 467426, 'ita-riveduta': 488029, 'kek-1988': 566061, 'kek-2005': 483255, 'kjb-kjb': 628032, 'lat-novavulgata': 369725, 'lit-lit': 336688, 'mah-mah': 502863, 'mam-northern': 535958, 'mri-mri': 634468, 'mya-mya': 282821, 'nld-nld': 518540, 'nor-nor': 466296, 'nor-student': 469807, 'plt-romancatholic': 440609, 'poh-eastern': 652635, 'por-almeidaatualizada': 468444, 'por-almeidarevista': 476851, 'por-paratodos': 463114, 'qub-qub': 336889, 'quh-1993': 349298, 'quy-quy': 331201, 'quz-quz': 321235, 'ron-cornilescu': 475436, 'rus-synodal': 389582, 'som-som': 456598, 'tbz-tbz': 440664, 'tcw-tcw': 405991, 'tgl-1905': 534064, 'tlh-klingon': 504584, 'tpi-tpi': 744628, 'tpm-tpm': 566093, 'ukr-1962': 415118, 'ukr-2009': 414869, 'vie-1926compounds': 511445, 'vie-1926nocompounds': 543753, 'vie-2002': 531766, 'wal-wal': 408001, 'wbm-wbm': 644598, 'xho-xho': 324375, 'zom-zom': 493190})
WORDTYPES.update({'afr-1953': 12852, 'aln-aln': 24260, 'arb-arb': 42536, 'arz-arz': 52163, 'ayr-1997': 70158, 'ayr-2011': 60230, 'bba-bba': 11267, 'ben-common': 16053, 'ben-mussolmani': 16061, 'bqc-bqc': 25226, 'bul-bul': 27825, 'bul-veren': 25005, 'cac-ixtatan': 15447, 'cak-central2003': 20702, 'ceb-bugna2009': 20090, 'ceb-bugna': 21465, 'ceb-pinadayag': 21454, 'ces-ekumenicky': 37710, 'ces-kralicka': 33359, 'cmn-sf_ncv-zefania': 59820, 'cnh-cnh': 10295, 'cym-morgan1804': 22415, 'dan-1931': 20009, 'deu-elberfelder1871': 20265, 'deu-elberfelder1905': 20214, 'deu-freebible': 20176, 'deu-gruenewalder': 26179, 'deu-luther1545letztehand': 20716, 'deu-luther1912': 17343, 'deu-neue': 22995, 'deu-pattloch': 24949, 'deu-schlachter': 21456, 'deu-textbibel': 24881, 'deu-zuercher': 22260, 'ell-modern2009': 29460, 'eng-darby': 12125, 'eng-kingjames': 10865, 'eng-literal': 11176, 'eng-newsimplified': 13010, 'epo-epo': 22077, 'fin-1766': 32693, 'fin-1933': 39868, 'fin-1992': 42030, 'fra-bonnet': 21806, 'fra-crampon': 23128, 'fra-darby': 19787, 'fra-davidmartin': 20595, 'fra-jerusalem2004': 24192, 'fra-kingjames': 20566, 'fra-louissegond': 20387, 'fra-ostervald1867': 20842, 'fra-paroledevie': 15078, 'fra-perret': 24210, 'fra-pirotclamer': 23744, 'guj-guj': 32069, 'gur-frafra': 9392, 'hat-1985': 6636, 'hat-1999': 7207, 'hrv-hrv': 36830, 'hun-2005': 45541, 'hun-karoli': 47078, 'ind-suciinjil': 17244, 'ind-terjemahanbaru': 16604, 'ita-2009': 25710, 'ita-diodati': 22261, 'ita-nuovadiodati1991': 23401, 'ita-riveduta': 23861, 'kek-1988': 16904, 'kek-2005': 21401, 'kjb-kjb': 11755, 'lat-novavulgata': 34539, 'lit-lit': 36552, 'mah-mah': 7196, 'mam-northern': 12352, 'mri-mri': 7058, 'mya-mya': 77261, 'nld-nld': 15632, 'nor-nor': 15655, 'nor-student': 18736, 'plt-romancatholic': 26430, 'poh-eastern': 14591, 'por-almeidaatualizada': 24078, 'por-almeidarevista': 22703, 'por-paratodos': 23910, 'qub-qub': 54248, 'quh-1993': 54389, 'quy-quy': 63005, 'quz-quz': 57729, 'ron-cornilescu': 19215, 'rus-synodal': 36285, 'som-som': 30820, 'tbz-tbz': 17623, 'tcw-tcw': 54568, 'tgl-1905': 19819, 'tlh-klingon': 10614, 'tpi-tpi': 3458, 'tpm-tpm': 8156, 'ukr-1962': 34760, 'ukr-2009': 34799, 'vie-1926compounds': 9071, 'vie-1926nocompounds': 6429, 'vie-2002': 8813, 'wal-wal': 35088, 'wbm-wbm': 5277, 'xho-xho': 60814, 'zom-zom': 20115})
UNIGRAM_ENTROPY.update({'afr-1953': 8.4906982820506, 'aln-aln': 9.259862001575248, 'arb-arb': 11.613698823639234, 'arz-arz': 11.427868856317746, 'ayr-1997': 11.645389538677312, 'ayr-2011': 11.352425755014826, 'bba-bba': 8.708692558085646, 'ben-common': 9.935176528372587, 'ben-mussolmani': 9.944711566141407, 'bqc-bqc': 9.545410513357387, 'bul-bul': 9.574224287748054, 'bul-veren': 9.459377242479025, 'cac-ixtatan': 8.466202331674644, 'cak-central2003': 8.37005295503414, 'ceb-bugna2009': 8.274981218690591, 'ceb-bugna': 8.392038328274527, 'ceb-pinadayag': 8.38716855114602, 'ces-ekumenicky': 10.50728923273534, 'ces-kralicka': 10.152853623538187, 'cmn-sf_ncv-zefania': 10.436734554552055, 'cnh-cnh': 8.294875370513031, 'cym-morgan1804': 9.145310371334844, 'dan-1931': 9.30454047757372, 'deu-elberfelder1871': 9.26739752836395, 'deu-elberfelder1905': 9.264329541808676, 'deu-freebible': 9.264173176364933, 'deu-gruenewalder': 9.752231944733817, 'deu-luther1545letztehand': 9.213730710498593, 'deu-luther1912': 9.268153608623765, 'deu-neue': 9.635995706563858, 'deu-pattloch': 9.701834561405025, 'deu-schlachter': 9.440772006812745, 'deu-textbibel': 9.643475316467747, 'deu-zuercher': 9.5144553380205, 'ell-modern2009': 9.484754761404977, 'eng-darby': 8.528016205898313, 'eng-kingjames': 8.462214732159348, 'eng-literal': 8.44145529654739, 'eng-newsimplified': 8.911804732376599, 'epo-epo': 8.9382896688397, 'fin-1766': 10.040074304507117, 'fin-1933': 10.416254029302776, 'fin-1992': 10.804705797984816, 'fra-bonnet': 9.291616355273518, 'fra-crampon': 9.345829266559706, 'fra-darby': 9.036193835526214, 'fra-davidmartin': 9.170660925427603, 'fra-jerusalem2004': 9.504952367357724, 'fra-kingjames': 9.20188888742427, 'fra-louissegond': 9.304515606914267, 'fra-ostervald1867': 9.206809060359083, 'fra-paroledevie': 9.183367124451317, 'fra-perret': 9.385265254605446, 'fra-pirotclamer': 9.455389737967524, 'guj-guj': 10.381337683773465, 'gur-frafra': 8.175321764436347, 'hat-1985': 8.064457482432916, 'hat-1999': 8.106149289485977, 'hrv-hrv': 10.46104963690107, 'hun-2005': 10.273810724088898, 'hun-karoli': 9.970314989521142, 'ind-suciinjil': 9.532873889414946, 'ind-terjemahanbaru': 9.431195716371693, 'ita-2009': 9.774663975205858, 'ita-diodati': 9.333755006268362, 'ita-nuovadiodati1991': 9.642426855142688, 'ita-riveduta': 9.577272937476572, 'kek-1988': 8.68055557617929, 'kek-2005': 8.90416600891119, 'kjb-kjb': 8.428490760776283, 'lat-novavulgata': 10.238823149855435, 'lit-lit': 10.478806306826998, 'mah-mah': 8.276533180517548, 'mam-northern': 9.07024066618153, 'mri-mri': 7.503823588210915, 'mya-mya': 11.01225328547847, 'nld-nld': 8.855058042177674, 'nor-nor': 9.080024076092972, 'nor-student': 9.10723920332091, 'plt-romancatholic': 9.428409935446195, 'poh-eastern': 8.201487308297299, 'por-almeidaatualizada': 9.206612628373737, 'por-almeidarevista': 9.04276203981656, 'por-paratodos': 9.59482832728565, 'qub-qub': 11.447512737690625, 'quh-1993': 11.138712931847545, 'quy-quy': 11.837540526005293, 'quz-quz': 11.4466400828567, 'ron-cornilescu': 9.51289519396345, 'rus-synodal': 10.099589645036959, 'som-som': 9.960794040294715, 'tbz-tbz': 9.481949769017572, 'tcw-tcw': 11.181926753645264, 'tgl-1905': 8.387246634308525, 'tlh-klingon': 8.006660194847637, 'tpi-tpi': 7.039959755444674, 'tpm-tpm': 8.104980220407981, 'ukr-1962': 9.917721033509961, 'ukr-2009': 9.915061412091623, 'vie-1926compounds': 8.857306812785268, 'vie-1926nocompounds': 8.902036390471709, 'vie-2002': 9.325516427543967, 'wal-wal': 10.45900180493281, 'wbm-wbm': 7.888059327646091, 'xho-xho': 11.338934019042554, 'zom-zom': 8.836197046115734})

TYPETOKEN_RATIO = {k: v / WORDTOKS[k] for k, v in WORDTYPES.items()}

if False:
  CHARTOKS = {}
  WORDTOKS = {}
  WORDTYPES = {}
  UNIGRAM_ENTROPY = {}
  # LANGS = EP_LANGS
  LANGS = BIBLE_LANGS
  for lang in LANGS:
    with gzip.open(f"splits/{lang}.train.charunked.gz", 'rt', encoding = 'utf-8') as f:
      string = f.read()
      CHARTOKS[lang] = len(string)
      string = string.split()
      WORDTOKS[lang] = len(string)
      UNIGRAM_ENTROPY[lang] = 0
      for _, freq in collections.Counter(string).most_common():
        p = freq / WORDTOKS[lang]
        UNIGRAM_ENTROPY[lang] -= p * math.log2(p)
      string = set(string)
      WORDTYPES[lang] = len(string)
  print("CHARTOKS =", CHARTOKS)
  print("WORDTOKS =", WORDTOKS)
  print("WORDTYPES =", WORDTYPES)
  print("UNIGRAM_ENTROPY =", UNIGRAM_ENTROPY)

# This is where to bring it all back into log space!
def logspace(d):
  return {k: math.log(v) for k, v in d.items()}

# And then average across langs
def average_langs(d):
  return {l: np.mean([v for k, v in d.items() if k[:3] == l]) for l in sorted(list(set([k[:3] for k in d.keys()])))}

RNNLM_BPE_BEST = average_langs(logspace(RNNLM_BPE_BEST))
RNNLM_BPE_04 = average_langs(logspace(RNNLM_BPE_04))
RNNLM_CHARS = average_langs(logspace(RNNLM_CHARS))

CHARTOKS = average_langs(CHARTOKS)
BPETOKS = average_langs(BPETOKS)
WORDTOKS = average_langs(WORDTOKS)
WORDTYPES = average_langs(WORDTYPES)
UNIGRAM_ENTROPY = average_langs(UNIGRAM_ENTROPY)
TYPETOKEN_RATIO = average_langs(TYPETOKEN_RATIO)


ALL_PEARSON_PS = []
ALL_SPEARMAN_PS = []

def correlate(x_dict, y_dict, limit_to=None):
  keys = sorted([k for k in x_dict.keys() & y_dict.keys() if limit_to is None or k in limit_to])
  # print("1", x_dict.keys())
  # print("2", y_dict.keys())
  if len(keys) > 0:
    x_name = [name for name, var in globals().items() if var is x_dict][0]
    y_name = [name for name, var in globals().items() if var is y_dict][0]
    print(f"{x_name} -> {y_name} on {len(keys)}: {', '.join(keys)}")
    X = [x_dict[k] for k in keys]
    Y = [y_dict[k] for k in keys]
    pearson_corr, pearson_p = scipy.stats.pearsonr(X, Y)
    spearman_corr, spearman_p = scipy.stats.spearmanr(X, Y)
    ALL_PEARSON_PS.append(pearson_p)
    ALL_SPEARMAN_PS.append(spearman_p)
    print(f" -> Pearson:  {pearson_corr:.3f} at p = {pearson_p:.15f} {'!!!!!!!!!!' if pearson_p < (0.05*6/32) else ''}")
    print(f" -> Spearman: {spearman_corr:.3f} at p = {spearman_p:.15f} {'!!!!!!!!!!' if spearman_p < (0.05*6/32) else ''}")

# correlate(MCC, ADL)
# correlate(RNNLM_BPE_BEST, RNNLM_BPE_04)
# correlate(RNNLM_BPE_BEST, RNNLM_CHARS)
# correlate(RNNLM_BPE_04, RNNLM_CHARS)

for limit_to in [EP_LANGS, set(BIBLE_LANGS) - set(["cmn"])]:
  for x in [MCC, ADL, HPE_MEAN, HPE_SKEW, CHARTOKS, BPETOKS, WORDTOKS, WORDTYPES, UNIGRAM_ENTROPY, TYPETOKEN_RATIO]:  #, WORDTOKS]:
    # correlate(x, RNNLM_BPE_BEST, limit_to=limit_to)
    correlate(x, RNNLM_BPE_04, limit_to=limit_to)
    correlate(x, RNNLM_CHARS, limit_to=limit_to)
    print("")

# correlate(WORDTYPES, MCC)

# print([v for k, v in RNNLM_BPE_04.items() if len(k) == 3])
# print([v for k, v in RNNLM_CHARS.items() if len(k) == 3])

ALL_PEARSON_PS.sort()
ALL_SPEARMAN_PS.sort()

M = len(ALL_SPEARMAN_PS) + 4 # (for wals)
print("correct M =", M)

for M in range(17, 34):
  k_spearman = 0
  while ALL_SPEARMAN_PS[k_spearman] <= 0.05 * (k_spearman+1) / M:
    k_spearman += 1
  k_pearson = 0
  while ALL_PEARSON_PS[k_pearson] <= 0.05 * (k_pearson+1) / M:
    k_pearson += 1

  print(f"M = {M:2.0f} gives k_pearson = {k_pearson:2.0f} => p <= {0.05 * k_pearson / M:.5f} = 0.05*{k_pearson:2.0f}/{M:2.0f}   --   and k_spearman = {k_spearman:2.0f} => p <= {0.05 * k_spearman / M:.5f} = 0.05*{k_spearman:2.0f}/{M:2.0f}")
